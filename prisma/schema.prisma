// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Project {
  id                String             @id @default(cuid())
  title             String
  description       String
  tokenSymbol       String
  tokenSupply       Int
  ownershipPercent  Float
  creatorAddress    String
  tokenContractHash String?
  tokenPackageHash  String?
  tokenStatus       ProjectTokenStatus @default(PENDING)

  // New fields for enhanced project creation
  marketLevel       MarketLevel        @default(PRE_MARKET)
  category          ProjectCategory
  roadmap           String             // Milestones and timeline
  fundingGoal       Float              // Target CSPR to raise

  // Payment tracking
  platformFeeHash   String?            // Transaction hash for 20 CSPR platform fee
  liquidityPoolHash String?            // Transaction hash for 180 CSPR liquidity
  tokenDeployHash   String?            // Platform's CEP-18 token deployment hash

  // Token distribution tracking (platform deploys, then distributes to creator)
  creatorTokenAmount     Float?        // Tokens transferred to creator
  platformTokenAmount    Float?        // Tokens kept by platform for bonding curve
  tokenDistributionHash  String?       // Deploy hash of creator token transfer
  deployedBy             String?       // "PLATFORM" or "CREATOR" (legacy)

  // Approval tracking
  approvedAt        DateTime?          // When promoted to APPROVED market
  approvedBy        String?            // Admin wallet address who approved

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt

  metrics           ProjectMetric?
  orders            ProjectOrder[]
  bondingCurve      BondingCurve?
  marketCapHistory  MarketCapHistory[]
  priceHistory      PriceHistory[]

  @@unique([title])
}

model ProjectMetric {
  id             String @id @default(cuid())
  projectId      String @unique
  currentPrice   Float  @default(0)
  marketCap      Float  @default(0)
  liquidityUsd   Float  @default(0)
  totalInvestors Int    @default(0)

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model ProjectOrder {
  id            String      @id @default(cuid())
  projectId     String
  wallet        String
  side          OrderSide
  tokenAmount   Float       // Total tokens in order
  pricePerToken Float       // Limit price per token in CSPR
  filledAmount  Float       @default(0) // Tokens filled so far
  status        OrderStatus @default(OPEN)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  buyTrades  Trade[] @relation("BuyOrders")
  sellTrades Trade[] @relation("SellOrders")

  @@index([projectId, status, side, pricePerToken])
  @@index([projectId, createdAt])
  @@index([wallet, status])
}

model BondingCurve {
  id            String   @id @default(cuid())
  projectId     String   @unique
  initialPrice  Float    // Starting price per token
  reserveRatio  Float    // Curve steepness (0-1)
  currentSupply Float    @default(0) // Tokens sold so far
  reserveBalance Float   @default(180) // CSPR in reserve (180 from liquidity pool payment)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
}

model MarketCapHistory {
  id         String   @id @default(cuid())
  projectId  String
  marketCap  Float    // Market cap in USD at time of recording
  recordedAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, recordedAt])
}

model PriceHistory {
  id         String   @id @default(cuid())
  projectId  String
  open       Float    // Opening price in CSPR
  high       Float    // Highest price in CSPR
  low        Float    // Lowest price in CSPR
  close      Float    // Closing price in CSPR
  volume     Float    // Trading volume
  timestamp  DateTime @default(now())
  interval   String   // Time interval: "1m", "5m", "15m", "1h", "4h", "1d"

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId, timestamp])
  @@index([projectId, interval, timestamp])
}

model Trade {
  id              String      @id @default(cuid())
  projectId       String
  buyOrderId      String
  sellOrderId     String
  buyerWallet     String
  sellerWallet    String
  tokenAmount     Float       // Amount of tokens traded
  pricePerToken   Float       // Execution price per token in CSPR
  totalValue      Float       // tokenAmount * pricePerToken
  blockchainHash  String?     // Casper transfer deploy hash
  status          TradeStatus @default(PENDING)
  createdAt       DateTime    @default(now())
  executedAt      DateTime?   // When blockchain transaction was confirmed
  updatedAt       DateTime    @updatedAt

  buyOrder  ProjectOrder @relation("BuyOrders", fields: [buyOrderId], references: [id])
  sellOrder ProjectOrder @relation("SellOrders", fields: [sellOrderId], references: [id])

  @@index([projectId, createdAt])
  @@index([buyerWallet, createdAt])
  @@index([sellerWallet, createdAt])
  @@index([status])
  @@index([blockchainHash])
}

enum ProjectTokenStatus {
  PENDING
  DEPLOYED
  FAILED
}

enum OrderSide {
  BUY
  SELL
}

enum OrderStatus {
  OPEN             // Order is active and can be matched
  PARTIALLY_FILLED // Some tokens filled, remaining open
  FILLED           // Completely filled
  CANCELLED        // User cancelled
}

enum TradeStatus {
  PENDING    // Trade matched, awaiting blockchain execution
  EXECUTING  // Blockchain transaction submitted
  CONFIRMED  // Blockchain transaction confirmed
  FAILED     // Blockchain transaction failed
}

enum MarketLevel {
  PRE_MARKET // Level 1: New projects start here
  APPROVED   // Level 2: Promoted after meeting criteria
}

enum ProjectCategory {
  DEFI
  GAMING
  NFT
  DAO
  INFRASTRUCTURE
  METAVERSE
  SOCIAL
  MARKETPLACE
  TOOLS
  OTHER
}

model RollbackLog {
  id          String   @id @default(cuid())
  projectId   String
  tradeType   String   // "BUY" or "SELL"
  tokenAmount Float
  amount      Float    // CSPR amount (cost for buy, proceeds for sell)
  deployHash  String
  reason      String   // Reason for rollback
  createdAt   DateTime @default(now())

  @@index([projectId, createdAt])
  @@index([deployHash])
}

model CriticalAlert {
  id         String   @id @default(cuid())
  type       String   // Alert type (e.g., "ROLLBACK_FAILED")
  projectId  String
  deployHash String
  error      String
  metadata   String   // JSON string with additional context
  resolved   Boolean  @default(false)
  resolvedAt DateTime?
  resolvedBy String?  // Admin who resolved it
  createdAt  DateTime @default(now())

  @@index([resolved, createdAt])
  @@index([projectId])
  @@index([deployHash])
}
